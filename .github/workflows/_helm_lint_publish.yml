name: _Build and publish Helm Chart

on:
  workflow_call:
    inputs:
      release:
        type: boolean
        required: false
        default: false
      version:
        type: string
        required: false
      chart-testing-config:
        type: string
        required: false
        default: ".github/ct.yaml"
      charts-path:
        type: string
        required: false
        default: "./helm/charts/"

jobs:
  lint-chart:
    runs-on: [self-hosted, shared]
    steps:
      - name: Register dependencies repository
        shell: bash
        run: |
          if [ ! -z "${{ secrets.DEV_CHARTMUSEUM_URL }}" ]; then
            helm repo add dev-chartmuseum --username ${{ secrets.DEV_CHARTMUSEUM_USER }} --password ${{ secrets.DEV_CHARTMUSEUM_PASSWORD }} ${{ secrets.DEV_CHARTMUSEUM_URL }}
            helm repo update
          fi
          if [ ! -z "${{ secrets.PROD_CHARTMUSEUM_URL }}" ]; then
            helm repo add prd-chartmuseum --username ${{ secrets.PROD_CHARTMUSEUM_USER }} --password ${{ secrets.PROD_CHARTMUSEUM_PASSWORD }} ${{ secrets.PROD_CHARTMUSEUM_URL }}
            helm repo update
          fi
      - name: Run Chart lint
        uses: LedgerHQ/actions/helm/lint@add-reusable-workflow-helm
        with:
          chart-testing-config: ${{inputs.chart-testing-config}}

  kubeconform-chart:
    runs-on: [self-hosted, shared]
    strategy:
      matrix:
        k8s:
          - v1.22.4
          - v1.23.0
          - v1.24.0
    steps:
      - name: Register dependencies repository
        shell: bash
        run: |
          if [ ! -z "${{ secrets.PROD_CHARTMUSEUM_URL }}" ]; then
            helm repo add chartmuseum --username ${{ secrets.PROD_CHARTMUSEUM_USER }} --password ${{ secrets.PROD_CHARTMUSEUM_PASSWORD }} ${{ secrets.PROD_CHARTMUSEUM_URL }}
            helm repo update
          fi
      - name: Checkout
        uses: LedgerHQ/actions/helm/conform@add-reusable-workflow-helm
        with:
          kubernetes-version: ${{ matrix.k8s }}
          charts-path: ${{inputs.charts-path}}

  publish-chartmuseum-dev:
    name: publish-chartmuseum-dev
    environment: chartmuseum-dev
    if: inputs.version != ''
    runs-on: [self-hosted, shared]
    needs: [lint-chart, kubeconform-chart]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Push chart to chartmuseum-prd repo
        uses: LedgerHQ/actions/helm/publish-cm@add-reusable-workflow-helm
        with:
          charts-path: ${{inputs.charts-path}}
          version: ${{ inputs.version }}
          chartmuseum-url: ${{ secrets.CHARTMUSEUM_URL }}
          chartmuseum-user: ${{ secrets.CHARTMUSEUM_USER }}
          chartmuseum-password: ${{ secrets.CHARTMUSEUM_PASSWORD }}
          force: true

  publish-chartmuseum-prd:
    name: publish-chartmuseum-prd
    environment: chartmuseum-prd
    if: inputs.version != '' && inputs.release != false
    runs-on: [self-hosted, shared]
    needs: [publish-chartmuseum-dev]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Push chart to chartmuseum-prd repo
        uses: LedgerHQ/actions/helm/publish-cm@add-reusable-workflow-helm
        with:
          charts-path: ${{inputs.charts-path}}
          version: ${{ inputs.version }}
          chartmuseum-url: ${{ secrets.CHARTMUSEUM_URL }}
          chartmuseum-user: ${{ secrets.CHARTMUSEUM_USER }}
          chartmuseum-password: ${{ secrets.CHARTMUSEUM_PASSWORD }}
          force: true
